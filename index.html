<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llamadas con Firebase y WebRTC</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2c2f36;
            color: #fff;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #36393f;
            padding: 10px;
            text-align: center;
        }
        #callContainer {
            margin: 20px auto;
            width: 90%;
            max-width: 600px;
            background-color: #3a3f44;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        #inputCallId {
            width: 80%;
            padding: 8px;
            border-radius: 5px;
            border: none;
            margin-bottom: 15px;
        }
        #startCallBtn, #joinCallBtn {
            background-color: #7289da;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        #startCallBtn:hover, #joinCallBtn:hover {
            background-color: #5a6fb4;
        }
        video {
            width: 100%;
            max-width: 500px;
            border: 2px solid #fff;
            margin-top: 15px;
        }
    </style>
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "BKLyJFYREVkvnHCELpDH2sXCnJ6HA4KtZZ6Z_YOKQizNSVPDaeAGatCc-YOO81JWxGIJWTxP6mvTSW1jVCwoSWs", 
            authDomain: "llamadas-20257.firebaseapp.com",
            databaseURL: "https://llamadas-20257-default-rtdb.firebaseio.com",
            projectId: "llamadas-20257",
            storageBucket: "llamadas-20257.appspot.com",
            messagingSenderId: "943167410469",
            appId: "1:943167410469:web:XXXXXXXXXXXXX"
        };

        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);

        let localStream;
        let remoteStream;
        let peerConnection;
        let userJoined = false;
        let currentCallId = null;

        // Parámetros de conexión WebRTC
        const servers = {
            iceServers: [{
                urls: 'stun:stun.l.google.com:19302'
            }]
        };

        // Crear una llamada
        function startCall() {
            const callId = generateId(); // ID único de la llamada
            currentCallId = callId;
            document.getElementById("callId").innerText = callId;

            // Referencia a la base de datos de Firebase
            const callRef = firebase.database().ref('calls/' + callId);

            // Guardar los datos de la llamada en Firebase
            callRef.set({
                active: true,
                userA: true, // Usuario A está en la llamada
                userB: false, // Usuario B aún no está
                createdAt: Date.now(), // Marca de tiempo de creación
            }).then(() => {
                console.log("Llamada creada con ID:", callId);
            }).catch(error => {
                console.error("Error al crear llamada:", error);
            });

            // Iniciar la conexión WebRTC
            startWebRTC();
        }

        // Generar ID único para la llamada
        function generateId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Unirse a una llamada
        function joinCall() {
            const inputCallId = document.getElementById("inputCallId").value;
            if (!inputCallId) {
                alert("Por favor, ingresa un ID de llamada.");
                return;
            }

            // Verificar si la llamada está activa
            const callRefToJoin = firebase.database().ref('calls/' + inputCallId);
            callRefToJoin.once('value', snapshot => {
                const callData = snapshot.val();
                if (callData && callData.active && !callData.userB) {
                    console.log("Llamada encontrada. Uniendo a la llamada...");

                    // Actualizar el estado para indicar que el usuario B se ha unido
                    callRefToJoin.update({
                        userB: true
                    });

                    // Iniciar la conexión WebRTC
                    startWebRTC();

                } else {
                    alert("El ID de llamada no es válido o la llamada ya está ocupada.");
                }
            }).catch(error => {
                console.error("Error al intentar unirse a la llamada:", error);
            });
        }

        // Iniciar WebRTC
        function startWebRTC() {
            // Obtener acceso al micrófono y cámara
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    // Mostrar el video local
                    localStream = stream;
                    const localVideo = document.createElement('video');
                    localVideo.srcObject = stream;
                    localVideo.autoplay = true;
                    document.body.appendChild(localVideo);

                    // Crear la conexión peer
                    peerConnection = new RTCPeerConnection(servers);
                    peerConnection.addStream(localStream);

                    peerConnection.onicecandidate = event => {
                        if (event.candidate) {
                            // Aquí irían los eventos para compartir la señal ICE (no implementado)
                        }
                    };

                    peerConnection.onaddstream = event => {
                        remoteStream = event.stream;
                        const remoteVideo = document.createElement('video');
                        remoteVideo.srcObject = remoteStream;
                        remoteVideo.autoplay = true;
                        document.body.appendChild(remoteVideo);
                    };

                    // Si estamos creando la llamada, se hace la oferta
                    if (currentCallId) {
                        peerConnection.createOffer()
                            .then(offer => {
                                return peerConnection.setLocalDescription(offer);
                            })
                            .then(() => {
                                // Aquí enviamos la oferta al otro usuario (por ejemplo, con Firebase)
                            })
                            .catch(error => {
                                console.error("Error al crear oferta: ", error);
                            });
                    }
                })
                .catch(error => {
                    console.error("Error al acceder al micrófono y cámara:", error);
                });
        }
    </script>
</head>
<body>
    <header>
        <h1>Llamadas con Firebase y WebRTC</h1>
    </header>

    <div id="callContainer">
        <p>Tu ID de llamada: <span id="callId"></span></p>
        <input type="text" id="inputCallId" placeholder="Ingrese ID para llamar">
        <button id="startCallBtn" onclick="startCall()">Crear llamada</button>
        <button id="joinCallBtn" onclick="joinCall()">Unirse a llamada</button>
    </div>
</body>
</html>
