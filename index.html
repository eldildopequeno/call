<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Llamadas con Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2c2f36;
            color: #fff;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #36393f;
            padding: 10px;
            text-align: center;
        }
        #callContainer {
            margin: 20px auto;
            width: 90%;
            max-width: 600px;
            background-color: #3a3f44;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        #inputCallId {
            width: 80%;
            padding: 8px;
            border-radius: 5px;
            border: none;
            margin-bottom: 15px;
        }
        #startCallBtn, #joinCallBtn, #generateIdBtn {
            background-color: #7289da;
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        #startCallBtn:hover, #joinCallBtn:hover, #generateIdBtn:hover {
            background-color: #5a6fb4;
        }
        #remoteAudio {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Llamadas con Firebase</h1>
    </header>

    <div id="callContainer">
        <p>Tu ID de llamada: <span id="callId"></span></p>
        <button id="generateIdBtn" onclick="generateAndDisplayId()">Generar ID</button>
        <input type="text" id="inputCallId" placeholder="Ingrese ID para llamar">
        <button id="startCallBtn" onclick="startCall()">Llamar</button>
        <button id="joinCallBtn" onclick="joinCall()">Unirse a llamada</button>

        <audio id="remoteAudio" controls autoplay></audio>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "BKLyJFYREVkvnHCELpDH2sXCnJ6HA4KtZZ6Z_YOKQizNSVPDaeAGatCc-YOO81JWxGIJWTxP6mvTSW1jVCwoSWs",
            authDomain: "llamadas-20257.firebaseapp.com",
            databaseURL: "https://llamadas-20257-default-rtdb.firebaseio.com",
            projectId: "llamadas-20257",
            storageBucket: "llamadas-20257.appspot.com",
            messagingSenderId: "943167410469",
            appId: "1:943167410469:web:XXXXXXXXXXXXX"
        };
        firebase.initializeApp(firebaseConfig);

        let currentCallId = null;
        let localStream;
        let remoteStream;
        let peerConnection;
        const config = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        };

        // Generación de ID único
        function generateId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // Muestra el ID generado en la página
        function generateAndDisplayId() {
            const generatedId = generateId(); // Genera un ID único
            currentCallId = generatedId; // Asigna el ID generado a currentCallId
            document.getElementById("callId").innerText = generatedId; // Muestra el ID en la página
        }

        // Inicia la llamada
        function startCall() {
            if (!currentCallId) {
                alert("Por favor, genera un ID de llamada primero.");
                return;
            }

            // Obtiene acceso al micrófono
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    localStream = stream;
                    document.getElementById("remoteAudio").srcObject = stream;

                    // Guarda la llamada en Firebase
                    const callRef = firebase.database().ref('calls/' + currentCallId);
                    callRef.set({
                        active: true,
                        generatedAt: Date.now(),
                        recordedAt: null,
                        participants: {
                            local: true
                        }
                    }).then(() => {
                        console.log("Llamada creada con ID:", currentCallId);
                    }).catch(error => {
                        console.error("Error al crear llamada:", error);
                    });
                })
                .catch(error => {
                    console.error("Error al obtener el audio:", error);
                });
        }

        // Unirse a la llamada
        function joinCall() {
            const inputCallId = document.getElementById("inputCallId").value;
            if (!inputCallId) {
                alert("Por favor, ingresa un ID de llamada.");
                return;
            }

            const callRef = firebase.database().ref('calls/' + inputCallId);
            callRef.once('value', snapshot => {
                const callData = snapshot.val();
                if (callData && callData.active) {
                    console.log("Llamada encontrada. Conectando...");

                    // Obtiene acceso al micrófono
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            localStream = stream;

                            // Crea la conexión WebRTC
                            peerConnection = new RTCPeerConnection(config);
                            peerConnection.addStream(localStream);

                            // Cuando se recibe el stream remoto
                            peerConnection.onaddstream = event => {
                                remoteStream = event.stream;
                                document.getElementById("remoteAudio").srcObject = remoteStream;
                            };

                            // Iniciar la señalización para WebRTC
                            createOffer(peerConnection);
                        })
                        .catch(error => {
                            console.error("Error al obtener el audio:", error);
                        });
                } else {
                    alert("El ID de llamada ingresado no es válido o está inactivo.");
                }
            }).catch(error => {
                console.error("Error al intentar unirse a la llamada:", error);
            });
        }

        // Crear la oferta WebRTC
        function createOffer(peerConnection) {
            peerConnection.createOffer().then(offer => {
                return peerConnection.setLocalDescription(offer);
            }).then(() => {
                // Guardar la oferta en Firebase
                const callRef = firebase.database().ref('calls/' + currentCallId);
                callRef.update({
                    offer: peerConnection.localDescription
                });
            }).catch(error => {
                console.error("Error al crear la oferta WebRTC:", error);
            });
        }
    </script>
</body>
</html>
