let localStream;
let remoteStream;
let peerConnection;
let isCalling = false;
const config = {
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
};

// Función para iniciar la llamada
function startCall() {
    const callId = generateId(); 
    currentCallId = callId;
    document.getElementById("callId").innerText = callId;

    // Obtiene el audio del micrófono local
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            localStream = stream;
            document.getElementById("remoteAudio").srcObject = stream; // Muestra el audio local (opcional)

            // Guarda la llamada en Firebase
            const callRef = firebase.database().ref('calls/' + callId);
            callRef.set({
                active: true,
                generatedAt: Date.now(),
                recordedAt: null,
                participants: {
                    local: true
                }
            }).then(() => {
                console.log("Llamada creada con ID:", callId);
            }).catch(error => {
                console.error("Error al crear llamada:", error);
            });
        })
        .catch(error => {
            console.error("Error al obtener el audio:", error);
        });
}

// Función para unirse a una llamada
function joinCall() {
    const inputCallId = document.getElementById("inputCallId").value;
    if (!inputCallId) {
        alert("Por favor, ingresa un ID de llamada.");
        return;
    }

    const callRef = firebase.database().ref('calls/' + inputCallId);
    callRef.once('value', snapshot => {
        const callData = snapshot.val();
        if (callData && callData.active) {
            console.log("Llamada encontrada. Conectando...");

            // Obtiene el audio del micrófono local
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    localStream = stream;

                    // Crea la conexión WebRTC
                    peerConnection = new RTCPeerConnection(config);

                    // Enviar el audio local a través de la conexión
                    peerConnection.addStream(localStream);

                    // Cuando recibimos un stream remoto
                    peerConnection.onaddstream = event => {
                        remoteStream = event.stream;
                        document.getElementById("remoteAudio").srcObject = remoteStream;
                    };

                    // Iniciar la señalización para WebRTC (esto debe ser manejado)
                    // Esto podría hacerse a través de Firebase, enviando las ofertas, respuestas y candidatos ICE
                    createOffer(peerConnection);
                })
                .catch(error => {
                    console.error("Error al obtener el audio:", error);
                });
        } else {
            alert("El ID de llamada ingresado no es válido o está inactivo.");
        }
    }).catch(error => {
        console.error("Error al intentar unirse a la llamada:", error);
    });
}

// Crear la oferta para WebRTC
function createOffer(peerConnection) {
    peerConnection.createOffer().then(offer => {
        return peerConnection.setLocalDescription(offer);
    }).then(() => {
        // Enviar la oferta a través de Firebase
        const callRef = firebase.database().ref('calls/' + currentCallId);
        callRef.update({
            offer: peerConnection.localDescription
        });
    }).catch(error => {
        console.error("Error al crear la oferta WebRTC:", error);
    });
}
